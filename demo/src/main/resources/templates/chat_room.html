<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Chat Room</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <style>
      /* Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }

      body {
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .chat-container {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        width: 100vw;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        align-items: center;
      }
      .chat-inner {
        width: 100%;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: transparent;
      }

      .chat-header {
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        color: white;
        padding: 40px 0 40px 0;
        font-size: 22px;
        font-weight: 600;
        text-align: center;
        letter-spacing: 1px;
        position: relative;
        box-shadow: 0 2px 8px rgba(30,60,114,0.08);
        width: 100%;
        border-radius: 0 0 12px 12px;
      }
      .top-left-btn, .top-right-btn {
        position: absolute;
        top: 30px;
        background: rgba(255,255,255,0.15);
        border: none;
        color: #fff;
        font-size: 16px;
        padding: 8px 18px;
        border-radius: 20px;
        cursor: pointer;
        z-index: 10;
        transition: background 0.2s;
      }
      .top-left-btn { left: 50%; transform: translateX(-600px); }
      .top-right-btn { right: 50%; transform: translateX(600px); }
      .top-left-btn:hover, .top-right-btn:hover { background: rgba(255,255,255,0.28); }

      .message-list {
        flex: 1;
        padding: 40px 0 30px 0;
        overflow-y: auto;
        background: transparent;
        display: flex;
        flex-direction: column;
        gap: 18px;
        list-style: none;
        position: relative;
        min-height: 0;
        width: 100%;
        box-sizing: border-box;
        margin-right: 40px;
      }
      .message-row {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        width: 100%;
        margin-bottom: 2px;
      }
      .sent {
        justify-content: flex-end;
      }
      .received {
        justify-content: flex-start;
      }
      .bubble {
        padding: 13px 18px;
        border-radius: 18px 18px 6px 18px;
        font-size: 15px;
        word-break: break-word;
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        color: white;
        box-shadow: 0 2px 8px rgba(30,60,114,0.10);
        min-width: 60px;
        max-width: 350px;
        position: relative;
        animation: fadeIn 0.3s ease-in-out;
      }
      .received .bubble {
        background: #e0e0e0;
        color: #222;
        border-radius: 18px 18px 18px 6px;
      }
      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        background: #fff;
        border: 2px solid #2a5298;
        box-shadow: 0 1px 4px rgba(30,60,114,0.10);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        color: #222;
      }
      .sent .avatar {
        background: linear-gradient(45deg,#1e3c72,#2a5298);
        color: #fff;
      }
      .meta {
        font-size: 11px;
        color: #bbb;
        margin: 2px 0 0 2px;
        display: block;
        text-align: right;
      }
      .received .meta {
        color: #888;
        text-align: left;
        margin-left: 0;
        margin-right: 2px;
      }

      .chat-input {
        display: flex;
        padding: 15px;
        background: white;
        gap: 10px;
        width: 100%;
        box-sizing: border-box;
      }

      .chat-input input {
        flex: 1;
        padding: 10px 15px;
        border: 1.5px solid #ccc;
        border-radius: 25px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .chat-input input:focus {
        border-color: #2a5298;
        outline: none;
        box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.2);
      }

      .chat-input button {
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .chat-input button:hover {
        background: linear-gradient(45deg, #2a5298, #1e3c72);
        transform: translateY(-2px);
      }

      .chat-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 10px 0;
        background: white;
        border-top: 1px solid #eee;
        width: 100%;
        box-sizing: border-box;
      }

      .chat-actions button {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .chat-actions button:hover {
        background: #c0392b;
      }

      @keyframes fadeIn { 
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 900px) {
        .chat-inner {
          max-width: 100vw;
        }
        .message-list, .chat-input, .chat-actions {
          padding-left: 10px;
          padding-right: 10px;
        }
        .top-left-btn { left: 10px; transform: none; }
        .top-right-btn { right: 10px; transform: none; }
      }
      @media (max-width: 600px) {
        .chat-header {
          font-size: 16px;
          padding: 16px 0;
        }
        .chat-input input {
          font-size: 13px;
        }
        .bubble {
          font-size: 13px;
          padding: 10px 12px;
          max-width: 90vw;
        }
        .avatar {
          width: 28px;
          height: 28px;
          font-size: 13px;
        }
        .message-list {
          padding-top: 18px;
          padding-bottom: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-inner">
        <!-- Tombol Kembali & Profile -->
        <button class="top-left-btn" onclick="window.location.href='/dashboard'">‚Üê Dashboard</button>
        <button class="top-right-btn" onclick="window.location.href='/profile'">Profile</button>

        <!-- Header -->
        <div class="chat-header">Chat Room: [[${roomName}]]</div>

        <!-- Area Pesan -->
        <div class="message-list" id="messageList">
          <!-- Pesan akan muncul di sini -->
        </div>

        <!-- Tombol Hapus -->
        <div class="chat-actions">
          <button onclick="deleteAllMessages()">Hapus Semua</button>
          <button onclick="deleteSelectedMessages()">Hapus Terpilih</button>
        </div>

        <!-- Input Pesan -->
        <div class="chat-input">
          <input type="text" id="content" placeholder="Ketik pesan..." />
          <button onclick="sendMessage()">Kirim</button>
        </div>

        <!-- Hidden CSRF Token -->
        <input type="hidden" id="csrfToken" th:value="${_csrf.token}" />
      </div>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const roomId = /*[(${roomId})]*/ 1;
      const userId = /*[(${#authentication.principal.id})]*/ 1;
      const csrfToken = document.getElementById("csrfToken")?.value || "token";
      /*]]>*/

      let stompClient = null;

      function connectWebSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function () {
            console.log("Connected to room:", roomId);

            // Subscribe ke room publik
            stompClient.subscribe(
              "/topic/public/room/" + roomId,
              function (response) {
                const message = JSON.parse(response.body);
                addMessageToUI(message);
              }
            );

            // Subscribe ke event hapus pesan
            stompClient.subscribe(
              "/topic/message/deleted",
              function (response) {
                const data = JSON.parse(response.body);
                const messageId = data.messageId;

                const messageElement = document.getElementById(
                  "message-" + messageId
                );
                if (messageElement) {
                  messageElement.remove();
                }
              }
            );

            // Subscribe ke event hapus semua
            stompClient.subscribe(
              "/topic/message/deleted/all",
              function (response) {
                const data = JSON.parse(response.body);
                const deletedRoomId = data.roomId;

                if (deletedRoomId === roomId) {
                  document.getElementById("messageList").innerHTML = "";
                }
              }
            );

            // Subscribe ke event hapus terpilih
            stompClient.subscribe(
              "/topic/message/deleted/selected",
              function (response) {
                try {
                  const data = JSON.parse(response.body);
                  const ids = data.ids;

                  ids.forEach((id) => {
                    const messageElement = document.getElementById(
                      "message-" + id
                    );
                    if (messageElement) {
                      messageElement.remove();
                    }
                  });
                } catch (e) {
                  console.error("Gagal parsing pesan WebSocket:", e);
                }
              }
            );
          },
          function (err) {
            console.error("Gagal koneksi ke WebSocket:", err);
          }
        );
      }

      function addMessageToUI(message) {
        const messageList = document.getElementById("messageList");
        const currentUsername = '[(${#authentication.principal.username})]';
        const isSender = message.username === currentUsername;

        // Row pesan (bukan card)
        const row = document.createElement("div");
        row.id = "message-" + message.id;
        row.className = "message-row " + (isSender ? "sent" : "received");

        // Avatar (inisial)
        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.style.background = isSender ? 'linear-gradient(45deg,#1e3c72,#2a5298)' : '#e0e0e0';
        avatar.style.display = 'flex';
        avatar.style.alignItems = 'center';
        avatar.style.justifyContent = 'center';
        avatar.style.fontWeight = 'bold';
        avatar.style.fontSize = '16px';
        avatar.style.color = isSender ? '#fff' : '#222';
        avatar.textContent = message.username ? message.username.charAt(0).toUpperCase() : '?';

        // Bubble pesan
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = message.content;

        // Meta (timestamp)
        const meta = document.createElement("span");
        meta.className = "meta";
        meta.textContent = message.timestampString;

        // Checkbox untuk hapus terpilih
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = message.id;
        checkbox.style.marginLeft = "10px";

        // Susun elemen sesuai posisi (kanan/kiri)
        if (isSender) {
          row.appendChild(meta);
          row.appendChild(bubble);
          row.appendChild(avatar);
        } else {
          row.appendChild(avatar);
          row.appendChild(bubble);
          row.appendChild(meta);
        }
        row.appendChild(checkbox);

        messageList.appendChild(row);
      }

      window.onload = function () {
        connectWebSocket();

        // Muat riwayat chat saat halaman dimuat
        fetch("/chat/history?roomId=" + roomId)
          .then((response) => response.json())
          .then((messages) => {
            messages.forEach((msg) => {
              addMessageToUI(msg);
            });
          });
      };

      function sendMessage() {
        if (!stompClient || !stompClient.connected) {
          alert("Belum terhubung ke WebSocket");
          return;
        }

        const content = document.getElementById("content").value.trim();
        if (content === "") return;

        stompClient.send(
          "/app/chat.send",
          {},
          JSON.stringify({
            content: content,
            user: { id: userId },
            roomPublic: { id: roomId },
          })
        );

        document.getElementById("content").value = "";
      }

      // ‚úÖ Fungsi Hapus Semua
      function deleteAllMessages() {
        const csrfToken = document.getElementById("csrfToken").value;

        if (!confirm("Yakin ingin menghapus semua pesan?")) return;

        fetch("/message/delete/all", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": csrfToken,
          },
          body: JSON.stringify({ roomId: roomId }), // Pastikan roomId dikirim
        })
          .then((response) => {
            if (response.ok) {
              console.log("Semua pesan dihapus");
            } else {
              console.error("Gagal hapus semua pesan");
            }
          })
          .catch((err) => console.error("Error:", err));
      }

      // ‚úÖ Fungsi Hapus Terpilih
      function deleteSelectedMessages() {
        const checkboxes = document.querySelectorAll(
          'input[type="checkbox"]:checked'
        );
        const ids = Array.from(checkboxes).map((cb) => Number(cb.value));

        if (ids.length === 0) {
          alert("Pilih pesan yang ingin dihapus!");
          return;
        }

        fetch("/message/delete/selected", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ ids, roomId }),
        })
          .then((response) => {
            // ‚úÖ Cek apakah respons OK (200)
            if (response.ok) {
              // ‚úÖ Hapus dari UI tanpa parsing JSON
              ids.forEach((id) => {
                const messageElement = document.getElementById("message-" + id);
                if (messageElement) {
                  messageElement.remove();
                }
              });
            } else {
              throw new Error("Gagal menghapus pesan");
            }
          })
          .catch((err) => {
            console.error("Error saat hapus terpilih:", err);
            // ‚úÖ Tidak tampilkan alert jika error
          });
      }
    </script>
  </body>
</html>
